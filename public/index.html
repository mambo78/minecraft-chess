<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎮 Mathias Chess v6</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=VT323:wght@400&display=swap" rel="stylesheet">
</head>
<body>
    <div class="game-container">
        <header class="header">
            <h1 class="title">🎮 Mathias Chess v6 🎮</h1>
            <div class="player-info">
                <span class="white-info">White</span>
                <div class="turn-display" id="turn-display">White's Turn</div>
                <span class="black-info">Black</span>
            </div>
        </header>

        <main class="game-section">
            <div class="board-area">
                <div class="coords-left">
                    <div>8</div><div>7</div><div>6</div><div>5</div>
                    <div>4</div><div>3</div><div>2</div><div>1</div>
                </div>
                <div class="board-wrapper">
                    <div class="chess-board" id="chess-board">
                        <!-- Squares generated by JavaScript -->
                    </div>
                    <div class="coords-bottom">
                        <div>a</div><div>b</div><div>c</div><div>d</div>
                        <div>e</div><div>f</div><div>g</div><div>h</div>
                    </div>
                </div>
            </div>

            <!-- Game Controls -->
            <aside class="game-controls">
                <div class="control-section">
                    <h3>🎮 Game Mode</h3>
                    <div class="mode-buttons">
                        <button id="human-mode-btn" class="btn mode-btn active">👥 vs Human</button>
                        <button id="ai-mode-btn" class="btn mode-btn">🤖 vs AI</button>
                    </div>
                </div>

                <div class="control-section">
                    <h3>🎨 Themes</h3>
                    <select id="theme-selector" class="select-input">
                        <option value="classic">Classic Chess</option>
                        <option value="minecraft">🎮 Minecraft</option>
                        <option value="mario">🍄 Mario Bros</option>
                        <option value="sonic">💨 Sonic</option>
                        <option value="pokemon">⚡ Pokémon</option>
                        <option value="space">🚀 Space</option>
                        <option value="medieval">⚔️ Medieval</option>
                    </select>
                    <button id="random-theme-btn" class="btn">🎲 Random Theme</button>
                </div>

                <div class="control-section">
                    <h3>Game Controls</h3>
                    <button id="new-game-btn" class="btn">🔄 New Game</button>
                    <button id="undo-btn" class="btn">↶ Undo Move</button>
                </div>
            </aside>
        </main>
    </div>

    <!-- Game Message -->
    <div id="game-message" class="game-message" style="display: none;"></div>

    <script>
        // Game state variables
        let board = [
            ['r','n','b','q','k','b','n','r'],
            ['p','p','p','p','p','p','p','p'],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            [null,null,null,null,null,null,null,null],
            ['P','P','P','P','P','P','P','P'],
            ['R','N','B','Q','K','B','N','R']
        ];

        let currentPlayer = 'white';
        let selectedSquare = null;
        let gameMode = 'human';
        let currentTheme = 'classic';

        // Theme definitions with VERY distinct pieces
        const themes = {
            classic: {
                name: 'Classic Chess',
                pieces: {
                    'K': '♔', 'Q': '♕', 'R': '♖', 'B': '♗', 'N': '♘', 'P': '♙',
                    'k': '♚', 'q': '♛', 'r': '♜', 'b': '♝', 'n': '♞', 'p': '♟'
                }
            },
            minecraft: {
                name: '🎮 Minecraft',
                pieces: {
                    'K': '👑', 'Q': '💎', 'R': '🏰', 'B': '🗡️', 'N': '🐎', 'P': '⬜',
                    'k': '🎯', 'q': '🔥', 'r': '🏯', 'b': '⚔️', 'n': '🦄', 'p': '⬛'
                }
            },
            mario: {
                name: '🍄 Mario Bros',
                pieces: {
                    'K': '🍄', 'Q': '⭐', 'R': '🎮', 'B': '🔴', 'N': '🦆', 'P': '🟡',
                    'k': '👾', 'q': '💀', 'r': '🎲', 'b': '🔵', 'n': '🐢', 'p': '🟤'
                }
            },
            sonic: {
                name: '💨 Sonic',
                pieces: {
                    'K': '💍', 'Q': '💎', 'R': '🏃', 'B': '⚡', 'N': '🦔', 'P': '💙',
                    'k': '🤖', 'q': '💀', 'r': '🚁', 'b': '🔴', 'n': '👹', 'p': '🖤'
                }
            },
            pokemon: {
                name: '⚡ Pokémon',
                pieces: {
                    'K': '⚡', 'Q': '🔥', 'R': '💧', 'B': '🍃', 'N': '🌟', 'P': '⚪',
                    'k': '🌙', 'q': '❄️', 'r': '🌊', 'b': '🌺', 'n': '✨', 'p': '⚫'
                }
            },
            space: {
                name: '🚀 Space',
                pieces: {
                    'K': '🚀', 'Q': '🛸', 'R': '🌍', 'B': '🌟', 'N': '👽', 'P': '🔵',
                    'k': '🌑', 'q': '☄️', 'r': '🪐', 'b': '⭐', 'n': '👾', 'p': '🔴'
                }
            },
            medieval: {
                name: '⚔️ Medieval',
                pieces: {
                    'K': '👑', 'Q': '👸', 'R': '🏰', 'B': '⛪', 'N': '🐴', 'P': '🛡️',
                    'k': '🤴', 'q': '🧙‍♀️', 'r': '🏯', 'b': '🗿', 'n': '🐉', 'p': '⚔️'
                }
            }
        };

        let pieceSymbols = themes.classic.pieces;

        function initGame() {
            console.log('🚀 Starting Chess Game v6...');
            createBoard();
            updateBoard();
            setupControls();
            showMessage('✅ Chess game loaded successfully!', 2000);
        }

        function createBoard() {
            const boardElement = document.getElementById('chess-board');
            boardElement.innerHTML = '';
            
            for (let rank = 8; rank >= 1; rank--) {
                for (let file = 0; file < 8; file++) {
                    const square = document.createElement('div');
                    const isLight = (rank + file) % 2 === 0;
                    
                    square.className = `square ${isLight ? 'light' : 'dark'}`;
                    square.dataset.rank = rank - 1;
                    square.dataset.file = file;
                    square.addEventListener('click', () => handleSquareClick(rank - 1, file));
                    
                    boardElement.appendChild(square);
                }
            }
        }

        function updateBoard() {
            const squares = document.querySelectorAll('.square');
            squares.forEach(square => {
                const rank = parseInt(square.dataset.rank);
                const file = parseInt(square.dataset.file);
                const piece = board[7-rank][file];
                
                square.textContent = piece ? (pieceSymbols[piece] || piece) : '';
                square.classList.remove('selected');
                
                if (selectedSquare && selectedSquare.rank === rank && selectedSquare.file === file) {
                    square.classList.add('selected');
                }
            });
        }

        function handleSquareClick(rank, file) {
            const piece = board[7-rank][file];
            
            if (selectedSquare) {
                if (selectedSquare.rank === rank && selectedSquare.file === file) {
                    selectedSquare = null;
                } else {
                    const moveSuccessful = makeMove(selectedSquare.rank, selectedSquare.file, rank, file);
                    selectedSquare = null;
                    
                    // Trigger AI move if in AI mode and it's now black's turn
                    console.log('After move: gameMode =', gameMode, 'moveSuccessful =', moveSuccessful, 'currentPlayer =', currentPlayer);
                    if (gameMode === 'ai' && moveSuccessful && currentPlayer === 'black') {
                        console.log('✅ Triggering AI move in 800ms...');
                        showMessage('🤖 AI is thinking...', 800);
                        setTimeout(() => {
                            console.log('⏰ AI timeout triggered, calling makeAIMove()');
                            makeAIMove();
                        }, 800);
                    } else {
                        console.log('❌ AI not triggered. Conditions not met.');
                    }
                }
            } else {
                if (piece && isCurrentPlayerPiece(piece)) {
                    selectedSquare = { rank, file };
                }
            }
            
            updateBoard();
            updateTurnDisplay();
        }

        function isCurrentPlayerPiece(piece) {
            if (currentPlayer === 'white') {
                return piece === piece.toUpperCase();
            } else {
                return piece === piece.toLowerCase();
            }
        }

        function makeMove(fromRank, fromFile, toRank, toFile) {
            const piece = board[7-fromRank][fromFile];
            
            if (!piece || !isCurrentPlayerPiece(piece)) {
                return false;
            }
            
            board[7-toRank][toFile] = piece;
            board[7-fromRank][fromFile] = null;
            
            currentPlayer = currentPlayer === 'white' ? 'black' : 'white';
            
            return true;
        }

        function getValidMovesForPiece(piece, fromRow, fromCol, board) {
            const moves = [];
            const pieceType = piece.toLowerCase();
            const isBlack = piece === piece.toLowerCase();
            
            function addMoveIfValid(toRow, toCol) {
                if (toRow >= 0 && toRow < 8 && toCol >= 0 && toCol < 8) {
                    const target = board[toRow][toCol];
                    // Can move to empty square or capture opponent piece
                    if (!target || (isBlack && target === target.toUpperCase()) || (!isBlack && target === target.toLowerCase())) {
                        moves.push({
                            fromRow, fromCol, toRow, toCol, 
                            piece, captured: target
                        });
                    }
                }
            }
            
            switch (pieceType) {
                case 'p': // Pawn
                    if (isBlack) {
                        // Black pawns move down (increasing row)
                        // Forward move
                        if (fromRow < 7 && !board[fromRow + 1][fromCol]) {
                            addMoveIfValid(fromRow + 1, fromCol);
                            // Two squares from starting position
                            if (fromRow === 1 && !board[fromRow + 2][fromCol]) {
                                addMoveIfValid(fromRow + 2, fromCol);
                            }
                        }
                        // Diagonal captures
                        if (fromRow < 7) {
                            if (fromCol > 0 && board[fromRow + 1][fromCol - 1] && board[fromRow + 1][fromCol - 1] === board[fromRow + 1][fromCol - 1].toUpperCase()) {
                                addMoveIfValid(fromRow + 1, fromCol - 1);
                            }
                            if (fromCol < 7 && board[fromRow + 1][fromCol + 1] && board[fromRow + 1][fromCol + 1] === board[fromRow + 1][fromCol + 1].toUpperCase()) {
                                addMoveIfValid(fromRow + 1, fromCol + 1);
                            }
                        }
                    }
                    break;
                    
                case 'r': // Rook
                    // Horizontal and vertical moves
                    const rookDirections = [[0,1], [0,-1], [1,0], [-1,0]];
                    for (let [dr, dc] of rookDirections) {
                        for (let i = 1; i < 8; i++) {
                            const newRow = fromRow + dr * i;
                            const newCol = fromCol + dc * i;
                            if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                                const target = board[newRow][newCol];
                                if (!target) {
                                    addMoveIfValid(newRow, newCol);
                                } else {
                                    if ((isBlack && target === target.toUpperCase()) || (!isBlack && target === target.toLowerCase())) {
                                        addMoveIfValid(newRow, newCol);
                                    }
                                    break; // Stop after hitting a piece
                                }
                            } else break;
                        }
                    }
                    break;
                    
                case 'n': // Knight
                    const knightMoves = [[2,1], [2,-1], [-2,1], [-2,-1], [1,2], [1,-2], [-1,2], [-1,-2]];
                    for (let [dr, dc] of knightMoves) {
                        addMoveIfValid(fromRow + dr, fromCol + dc);
                    }
                    break;
                    
                case 'b': // Bishop
                    const bishopDirections = [[1,1], [1,-1], [-1,1], [-1,-1]];
                    for (let [dr, dc] of bishopDirections) {
                        for (let i = 1; i < 8; i++) {
                            const newRow = fromRow + dr * i;
                            const newCol = fromCol + dc * i;
                            if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                                const target = board[newRow][newCol];
                                if (!target) {
                                    addMoveIfValid(newRow, newCol);
                                } else {
                                    if ((isBlack && target === target.toUpperCase()) || (!isBlack && target === target.toLowerCase())) {
                                        addMoveIfValid(newRow, newCol);
                                    }
                                    break;
                                }
                            } else break;
                        }
                    }
                    break;
                    
                case 'q': // Queen (combination of rook and bishop)
                    const queenDirections = [[0,1], [0,-1], [1,0], [-1,0], [1,1], [1,-1], [-1,1], [-1,-1]];
                    for (let [dr, dc] of queenDirections) {
                        for (let i = 1; i < 8; i++) {
                            const newRow = fromRow + dr * i;
                            const newCol = fromCol + dc * i;
                            if (newRow >= 0 && newRow < 8 && newCol >= 0 && newCol < 8) {
                                const target = board[newRow][newCol];
                                if (!target) {
                                    addMoveIfValid(newRow, newCol);
                                } else {
                                    if ((isBlack && target === target.toUpperCase()) || (!isBlack && target === target.toLowerCase())) {
                                        addMoveIfValid(newRow, newCol);
                                    }
                                    break;
                                }
                            } else break;
                        }
                    }
                    break;
                    
                case 'k': // King
                    const kingMoves = [[0,1], [0,-1], [1,0], [-1,0], [1,1], [1,-1], [-1,1], [-1,-1]];
                    for (let [dr, dc] of kingMoves) {
                        addMoveIfValid(fromRow + dr, fromCol + dc);
                    }
                    break;
            }
            
            return moves;
        }
        
        function makeAIMove() {
            console.log('🤖 makeAIMove() called');
            console.log('🤖 currentPlayer:', currentPlayer);
            console.log('🤖 gameMode:', gameMode);
            
            if (currentPlayer !== 'black' || gameMode !== 'ai') {
                console.log('❌ AI move aborted - wrong conditions');
                console.log('  Expected: currentPlayer="black" and gameMode="ai"');
                console.log('  Got: currentPlayer="' + currentPlayer + '" and gameMode="' + gameMode + '"');
                return;
            }
            
            console.log('✅ AI conditions met, finding moves...');
            
            // Simple AI: find all black pieces and make valid chess moves
            const blackMoves = [];
            
            for (let fromRow = 0; fromRow < 8; fromRow++) {
                for (let fromCol = 0; fromCol < 8; fromCol++) {
                    const piece = board[fromRow][fromCol];
                    if (piece && piece === piece.toLowerCase()) {
                        // Get valid moves for this piece type
                        const validMoves = getValidMovesForPiece(piece, fromRow, fromCol, board);
                        blackMoves.push(...validMoves);
                    }
                }
            }
            
            console.log('🤖 Found', blackMoves.length, 'possible moves for AI');
            
            if (blackMoves.length > 0) {
                // Prefer captures
                let moves = blackMoves.filter(m => m.captured);
                if (moves.length === 0) moves = blackMoves;
                
                const move = moves[Math.floor(Math.random() * moves.length)];
                console.log('🤖 AI selected move:', move);
                
                board[move.toRow][move.toCol] = move.piece;
                board[move.fromRow][move.fromCol] = null;
                
                console.log('🤖 AI move executed, switching to white');
                currentPlayer = 'white';
                updateBoard();
                updateTurnDisplay();
                
                if (move.captured) {
                    showMessage(`🤖 AI captured your ${pieceSymbols[move.captured]}!`, 2000);
                } else {
                    showMessage("Your turn!", 2000);
                }
                console.log('✅ AI move completed successfully');
            } else {
                console.log('❌ AI found no possible moves!');
            }
        }

        function updateTurnDisplay() {
            const turnDisplay = document.getElementById('turn-display');
            if (gameMode === 'ai') {
                turnDisplay.textContent = currentPlayer === 'white' ? 'Your Turn' : '🤖 AI Turn';
            } else {
                turnDisplay.textContent = `${currentPlayer === 'white' ? 'White' : 'Black'}'s Turn`;
            }
        }

        function changeTheme(themeName) {
            if (themes[themeName]) {
                currentTheme = themeName;
                pieceSymbols = themes[themeName].pieces;
                updateBoard();
                showMessage(`Theme changed to ${themes[themeName].name}! 🎨`, 2000);
            }
        }

        function setupControls() {
            // New game
            document.getElementById('new-game-btn').addEventListener('click', () => {
                board = [
                    ['r','n','b','q','k','b','n','r'],
                    ['p','p','p','p','p','p','p','p'],
                    [null,null,null,null,null,null,null,null],
                    [null,null,null,null,null,null,null,null],
                    [null,null,null,null,null,null,null,null],
                    [null,null,null,null,null,null,null,null],
                    ['P','P','P','P','P','P','P','P'],
                    ['R','N','B','Q','K','B','N','R']
                ];
                currentPlayer = 'white';
                selectedSquare = null;
                updateBoard();
                updateTurnDisplay();
                showMessage('🔄 New game started!', 2000);
            });

            // Game modes
            document.getElementById('human-mode-btn').addEventListener('click', () => {
                gameMode = 'human';
                document.getElementById('human-mode-btn').classList.add('active');
                document.getElementById('ai-mode-btn').classList.remove('active');
                showMessage('👥 Human vs Human mode!', 2000);
                updateTurnDisplay();
            });
            
            document.getElementById('ai-mode-btn').addEventListener('click', () => {
                console.log('🎮 AI mode button clicked!');
                gameMode = 'ai';
                console.log('🎮 gameMode set to:', gameMode);
                document.getElementById('ai-mode-btn').classList.add('active');
                document.getElementById('human-mode-btn').classList.remove('active');
                showMessage('🤖 AI mode! You are White.', 2000);
                currentPlayer = 'white';
                console.log('🎮 currentPlayer set to:', currentPlayer);
                updateTurnDisplay();
            });

            // Themes
            document.getElementById('theme-selector').addEventListener('change', (e) => {
                changeTheme(e.target.value);
            });

            document.getElementById('random-theme-btn').addEventListener('click', () => {
                const themeNames = Object.keys(themes);
                const randomTheme = themeNames[Math.floor(Math.random() * themeNames.length)];
                document.getElementById('theme-selector').value = randomTheme;
                changeTheme(randomTheme);
            });
        }

        function showMessage(message, duration = 3000) {
            const messageElement = document.getElementById('game-message');
            messageElement.textContent = message;
            messageElement.style.display = 'block';
            messageElement.style.background = 'rgba(46, 204, 113, 0.9)';
            messageElement.style.color = 'white';
            messageElement.style.padding = '10px 20px';
            messageElement.style.borderRadius = '5px';
            messageElement.style.position = 'fixed';
            messageElement.style.top = '20px';
            messageElement.style.left = '50%';
            messageElement.style.transform = 'translateX(-50%)';
            messageElement.style.zIndex = '1000';
            
            if (duration > 0) {
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, duration);
            }
        }

        // Initialize game
        document.addEventListener('DOMContentLoaded', initGame);
        if (document.readyState !== 'loading') {
            initGame();
        }
    </script>
</body>
</html>